var l="https://api.dropcal.ai",w=null;function k(e){w=e}function f(){let e={"Content-Type":"application/json"};return w&&(e.Authorization=`Bearer ${w}`),e}async function d(e){if(!e.ok){let t=await e.json().catch(()=>({error:e.statusText}));throw new Error(t.error||`HTTP ${e.status}`)}return e.json()}async function D(e){let t=await fetch(`${l}/sessions`,{method:"POST",headers:f(),body:JSON.stringify({text:e})});return(await d(t)).session}async function z(e){let t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch image: ${t.status}`);let r=await t.blob(),n=new URL(e).pathname.split("/").pop()||"image.png",i=new FormData;i.append("file",r,n);let c={};w&&(c.Authorization=`Bearer ${w}`);let m=await fetch(`${l}/upload`,{method:"POST",headers:c,body:i});return(await d(m)).session}async function Q(e){let t=await fetch(`${l}/sessions/${e}`,{method:"GET",headers:f()});return(await d(t)).session}async function V(e){let t=await fetch(`${l}/sessions/${e}/events`,{method:"GET",headers:f()});return d(t)}async function Y(){let e=await fetch(`${l}/auth/profile`,{method:"GET",headers:f()});return(await d(e)).user.preferences||{}}async function q(){let e=await fetch(`${l}/auth/profile`,{method:"GET",headers:f()}),t=await d(e);return{email:t.user.email,display_name:t.user.display_name,photo_url:t.user.photo_url,plan:t.user.plan||"free",primary_calendar_provider:t.user.primary_calendar_provider,preferences:t.user.preferences||{}}}async function W(e){let t=await fetch(`${l}/auth/preferences`,{method:"PUT",headers:f(),body:JSON.stringify(e)});return d(t)}async function Z(){let e=await fetch(`${l}/calendar/provider/list`,{method:"GET",headers:f()});return d(e)}async function ee(e){let t=await fetch(`${l}/calendar/provider/set-primary`,{method:"POST",headers:f(),body:JSON.stringify({provider:e})});await d(t)}async function te(e){let t=await fetch(`${l}/calendar/provider/disconnect`,{method:"POST",headers:f(),body:JSON.stringify({provider:e})});await d(t)}async function re(e,t){let r=await fetch(`${l}/events/push`,{method:"POST",headers:f(),body:JSON.stringify({event_ids:t,session_id:e})});return d(r)}var p=globalThis.chrome,he=typeof browser<"u",s=he?browser:p,oe=typeof p<"u"&&"sidePanel"in p,ge=typeof browser<"u"&&typeof browser.sidebarAction?.open=="function",R=typeof p<"u"&&typeof p.storage<"u"&&"session"in p.storage,ne=typeof p<"u"&&typeof p.action?.openPopup=="function",E=typeof p<"u"&&"alarms"in p;var h="__session:";function se(e){return typeof e=="string"?[`${h}${e}`]:Array.isArray(e)?e.map(t=>`${h}${t}`):Object.keys(e).map(t=>`${h}${t}`)}function ie(e){let t={};for(let[r,o]of Object.entries(e))t[`${h}${r}`]=o;return t}function ye(e){let t={};for(let[r,o]of Object.entries(e))r.startsWith(h)&&(t[r.slice(h.length)]=o);return t}var B=new Set,ae=!1;function ve(){ae||(ae=!0,s.storage.local.onChanged.addListener(e=>{if(B.size===0)return;let t={},r=!1;for(let[o,n]of Object.entries(e))o.startsWith(h)&&(t[o.slice(h.length)]=n,r=!0);if(r)for(let o of B)o(t,"session")}))}var ce={get(e,t){let r=e===null?null:se(e);s.storage.local.get(r,o=>{t(ye(o))})},set(e,t){t?s.storage.local.set(ie(e),t):s.storage.local.set(ie(e))},remove(e,t){let r=se(e);t?s.storage.local.remove(r,t):s.storage.local.remove(r)},clear(e){s.storage.local.get(null,t=>{let r=Object.keys(t).filter(o=>o.startsWith(h));r.length>0?e?s.storage.local.remove(r,e):s.storage.local.remove(r):e?.()})},onChanged:{addListener(e){ve(),B.add(e)}}};function L(){R||ce.clear()}function Pe(){let e=s.storage.session;return{get(t,r){e.get(t,r)},set(t,r){r?e.set(t,r):e.set(t)},remove(t,r){r?e.remove(t,r):e.remove(t)},clear(t){t?e.clear(t):e.clear()},onChanged:e.onChanged}}var a={local:s.storage.local,session:R?Pe():ce,onChanged:s.storage.onChanged};function Se(){return{isSupported:!0,async open({windowId:e,sessionId:t}){t&&await new Promise(r=>{a.session.set({sidebarSessionId:t},r)}),e&&await s.sidePanel.open({windowId:e})}}}function we(){return{isSupported:!0,async open({sessionId:e}){await browser.sidebarAction.open(),e&&a.session.set({sidebarSessionId:e})}}}var $=oe?Se():we();var u={setBadgeText(e){s.action.setBadgeText(e)},setBadgeBackgroundColor(e){s.action.setBadgeBackgroundColor(e)},async tryOpenPopup(){if(ne)try{await s.action.openPopup()}catch{}}};var je=1/30,Te=2e3,O="poll-keepalive",U=null,y=new Set,F=new Map;function M(e){U=e,E&&s.alarms.onAlarm.addListener(t=>{t.name})}function T(e){y.add(e),Ce(),Ae(e)}function A(e){y.delete(e);let t=F.get(e);t&&(clearTimeout(t),F.delete(e)),y.size===0&&xe()}function Ae(e){if(!y.has(e))return;let t=async()=>{if(!(!y.has(e)||!U)){try{await U(e)}catch{}y.has(e)&&F.set(e,setTimeout(t,Te))}};t()}function Ce(){E&&s.alarms.get(O,e=>{e||s.alarms.create(O,{periodInMinutes:.5})})}function xe(){E&&s.alarms.clear(O)}var _e=5*60*1e3,be=10,de="send-to-dropcal",le="https://dropcal.ai",ke=24*60*60*1e3;L();async function J(){return new Promise(e=>{a.local.get("auth",t=>{e(t.auth||null)})})}async function Ee(e){await new Promise(t=>{a.local.set({auth:e},t)}),k(e.accessToken),Oe()}async function Oe(){try{let t=(await Y()).theme_mode||"auto";a.local.set({themeMode:t})}catch{}}async function N(){await new Promise(e=>{a.local.remove(["auth","themeMode"],e)}),k(null)}async function g(){let e=await J();return e?e.expiresAt&&Date.now()/1e3>e.expiresAt-60?(await N(),!1):(k(e.accessToken),!0):!1}async function x(){return new Promise(e=>{a.local.get("sessionHistory",t=>{e(t.sessionHistory||{sessions:[]})})})}async function ue(e){e.sessions=e.sessions.slice(0,be),await new Promise(t=>{a.local.set({sessionHistory:e},t)}),X()}async function I(e){let t=await x();t.sessions=t.sessions.filter(r=>r.sessionId!==e.sessionId),t.sessions.unshift(e),await ue(t)}async function P(e,t){let r=await x(),o=r.sessions.findIndex(n=>n.sessionId===e);o!==-1&&(r.sessions[o]={...r.sessions[o],...t},await ue(r))}async function j(){return new Promise(e=>{a.local.get("notificationQueue",t=>{e(t.notificationQueue||[])})})}async function fe(e){await new Promise(t=>{a.local.set({notificationQueue:e},t)}),X()}async function H(e){let t=await j();t.includes(e)||(t.push(e),await fe(t))}async function Ne(e){let t=await j();await fe(t.filter(r=>r!==e))}s.runtime.onInstalled.addListener(()=>{s.contextMenus.create({id:de,title:"Send to DropCal",contexts:["selection","image"]}),Ie()});async function Ie(){return new Promise(e=>{a.session.get("activeJob",t=>{let r=t.activeJob;if(r&&r.sessionId&&r.status==="processed"){let o={sessionId:r.sessionId,status:"processed",title:r.sessionTitle||null,eventCount:r.eventCount,addedToCalendar:!1,eventSummaries:(r.events||[]).slice(0,3).map(n=>n.summary),events:r.events||[],createdAt:r.createdAt,inputType:"text"};I(o).then(()=>{a.session.remove("activeJob",()=>e())})}else e()})})}s.contextMenus.onClicked.addListener(async e=>{if(!(e.menuItemId!==de||!await g()))try{let r,o="text";if(e.selectionText)_(),r=await D(e.selectionText),o="text";else if(e.srcUrl)_(),r=await z(e.srcUrl),o="image";else return;let n={sessionId:r.id,status:"polling",title:null,eventCount:0,addedToCalendar:!1,eventSummaries:[],events:[],createdAt:Date.now(),inputType:o};await I(n),T(r.id)}catch(r){console.error("DropCal: Failed to create session",r);let n=(r instanceof Error?r.message:"Unknown error").toLowerCase(),i=n.includes("401")||n.includes("403")||n.includes("authentication")||n.includes("jwt")||n.includes("token")||n.includes("expired");pe(),setTimeout(()=>X(),5e3),i&&await N()}});var v=new Map;M(async e=>{v.has(e)||v.set(e,Date.now());let t=v.get(e);if(Date.now()-t>_e){A(e),v.delete(e),await P(e,{status:"error",errorMessage:"Processing timed out. Please try again."}),await H(e);return}try{let r=await Q(e);if(r.status==="processed"){A(e),v.delete(e);let{events:n,count:i}=await V(e);await P(e,{status:"processed",title:r.title||null,icon:r.icon||null,eventCount:i,addedToCalendar:r.added_to_calendar,eventSummaries:n.slice(0,3).map(c=>c.summary),events:n}),await H(e),u.tryOpenPopup();return}if(r.status==="error"){A(e),v.delete(e),await P(e,{status:"error",errorMessage:r.error_message||"Processing failed"}),await H(e);return}let o={};r.title&&(o.title=r.title),r.icon&&(o.icon=r.icon),Object.keys(o).length>0&&await P(e,o)}catch(r){console.error("DropCal: Poll error",r)}});var C=null;function _(){if(C!==null)return;let e=["\u280B","\u2819","\u2839","\u2838","\u283C","\u2834","\u2826","\u2827","\u2807","\u280F"],t=0;u.setBadgeBackgroundColor({color:"#1170C5"}),u.setBadgeText({text:e[0]}),C=setInterval(()=>{t=(t+1)%e.length,u.setBadgeText({text:e[t]})},350)}function K(){C!==null&&(clearInterval(C),C=null)}function De(e){K(),u.setBadgeText({text:String(e)}),u.setBadgeBackgroundColor({color:"#2e7d32"})}function pe(){K(),u.setBadgeText({text:"!"}),u.setBadgeBackgroundColor({color:"#c41e3a"})}function G(){K(),u.setBadgeText({text:""})}async function X(){let[e,t]=await Promise.all([x(),j()]),r=e.sessions;if(r.some(i=>i.status==="polling")){_();return}let o=0,n=!1;for(let i of t){let c=r.find(m=>m.sessionId===i);!c||c.dismissedAt||Date.now()-c.createdAt>ke||(c.status==="error"||c.status==="processed"&&c.eventCount===0?n=!0:c.status==="processed"&&(o+=c.eventCount))}if(n){pe();return}if(o>0){De(o);return}G()}s.runtime.onMessage.addListener((e,t,r)=>{if(e.type==="AUTH_TOKEN"){let{accessToken:o,refreshToken:n,expiresAt:i}=e;return Ee({accessToken:o,refreshToken:n,expiresAt:i}).then(()=>{r({ok:!0})}),!0}if(e.type==="THEME_CHANGED"){let o=e.themeMode||"auto";return a.local.set({themeMode:o}),r({ok:!0}),!1}if(e.type==="AUTH_SIGNED_OUT")return N().then(()=>r({ok:!0})),!0;if(e.type==="GET_STATUS")return Promise.all([new Promise(o=>{a.session.get("activeJob",o)}),J()]).then(([o,n])=>{r({job:o.activeJob||null,isAuthenticated:!!n})}),!0;if(e.type==="GET_AUTH")return J().then(o=>{r({isAuthenticated:!!o})}),!0;if(e.type==="SIGN_IN"){let o=encodeURIComponent("Sign in to start creating events.");return s.tabs.create({url:`${le}/?auth=${o}`}),r({ok:!0}),!1}if(e.type==="OPEN_SESSION"){let{sessionId:o}=e,n=`${le}/s/${o}`;return s.tabs.create({url:n}),r({ok:!0}),!1}if(e.type==="CLEAR_JOB")return a.session.remove("activeJob"),G(),r({ok:!0}),!1;if(e.type==="SUBMIT_TEXT"){let{text:o}=e;return g().then(async n=>{if(!n){r({ok:!1,error:"Not authenticated"});return}try{_();let i=await D(o),c={sessionId:i.id,status:"polling",title:null,eventCount:0,addedToCalendar:!1,eventSummaries:[],events:[],createdAt:Date.now(),inputType:"text"};await I(c),T(i.id),r({ok:!0})}catch(i){console.error("DropCal: Submit text failed",i),G(),r({ok:!1})}}),!0}if(e.type==="TRACK_SESSION"){let{sessionId:o,inputType:n}=e;_();let i={sessionId:o,status:"polling",title:null,eventCount:0,addedToCalendar:!1,eventSummaries:[],events:[],createdAt:Date.now(),inputType:n||"file"};return I(i).then(()=>{T(o),r({ok:!0})}),!0}if(e.type==="GET_HISTORY")return x().then(o=>{r({sessions:o.sessions})}),!0;if(e.type==="OPEN_SIDEBAR"){let{sessionId:o}=e;return s.windows.getLastFocused().then(n=>{n.id&&$.open({windowId:n.id,sessionId:o}).catch(()=>{})}),r({ok:!0}),!1}if(e.type==="GET_USER_PROFILE")return g().then(async o=>{if(!o){r({ok:!1,error:"Not authenticated"});return}try{let n=await q();r({ok:!0,profile:n})}catch(n){console.error("DropCal: Failed to get profile",n),r({ok:!1,error:"Failed to load profile"})}}),!0;if(e.type==="UPDATE_PREFERENCES")return g().then(async o=>{if(!o){r({ok:!1,error:"Not authenticated"});return}try{let n=await W(e.preferences);e.preferences.theme_mode&&a.local.set({themeMode:e.preferences.theme_mode}),r({ok:!0,preferences:n.preferences})}catch(n){console.error("DropCal: Failed to update preferences",n),r({ok:!1,error:"Failed to save preferences"})}}),!0;if(e.type==="GET_CALENDAR_PROVIDERS")return g().then(async o=>{if(!o){r({ok:!1,error:"Not authenticated"});return}try{let n=await Z();r({ok:!0,providers:n.providers})}catch(n){console.error("DropCal: Failed to get providers",n),r({ok:!1,error:"Failed to load providers"})}}),!0;if(e.type==="SET_PRIMARY_PROVIDER")return g().then(async o=>{if(!o){r({ok:!1,error:"Not authenticated"});return}try{await ee(e.provider),r({ok:!0})}catch(n){console.error("DropCal: Failed to set primary",n),r({ok:!1,error:"Failed to set primary provider"})}}),!0;if(e.type==="DISCONNECT_PROVIDER")return g().then(async o=>{if(!o){r({ok:!1,error:"Not authenticated"});return}try{await te(e.provider),r({ok:!0})}catch(n){console.error("DropCal: Failed to disconnect",n),r({ok:!1,error:"Failed to disconnect provider"})}}),!0;if(e.type==="DISMISS_SESSION"){let{sessionId:o}=e;return Promise.all([Ne(o),P(o,{dismissedAt:Date.now()})]).then(()=>{r({ok:!0})}),!0}if(e.type==="PUSH_ALL_EVENTS"){let{sessionId:o}=e;return(async()=>{if(!await g())return{ok:!1,error:"Not authenticated"};let m=((await x()).sessions.find(S=>S.sessionId===o)?.events||[]).map(S=>S.id).filter(S=>!!S);if(m.length===0)return{ok:!1,error:"No events to add"};let b=await re(o,m);return b.success&&await P(o,{addedToCalendar:!0}),{ok:b.success,message:b.message}})().then(n=>r(n)).catch(n=>{console.error("DropCal: Push events failed",n),r({ok:!1,error:"Failed to add events to calendar"})}),!0}return e.type==="SIGN_OUT"?(N().then(()=>{r({ok:!0})}),!0):!1});
//# sourceMappingURL=background.js.map
