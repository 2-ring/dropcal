# Real-Time Session Title Generation

## Overview

This system generates concise, semantic titles for calendar sessions in real-time using KeyBERT (DistilBERT) and streams them to the frontend via Server-Sent Events (SSE).

**Key Features:**
- ‚ú® **Async generation** - Runs in parallel with main pipeline (no added latency)
- üöÄ **Real-time streaming** - Title appears in sidebar within 50-300ms
- üé≠ **Typing animation** - Smooth reveal effect when title arrives
- üíÄ **Skeleton loading** - Clean loading state before title is ready
- üìä **Zero blocking** - Session created immediately, title updates async

---

## Architecture

```
User submits input
      ‚Üì
Session created (placeholder title) ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚Üì                                   ‚Üì
Agent 1: Event ID (1-2s)           Title Gen (50-300ms) ‚ú®
      ‚Üì                                   ‚Üì
Agent 2: Facts (1-2s)              Title ‚Üí DB ‚Üí SSE Stream
      ‚Üì                                   ‚Üì
Agent 3: Formatting (1-2s)         Frontend receives ‚Üí Typing Animation
      ‚Üì
Done (3-6s total)
```

---

## Backend Implementation

### 1. Title Generator (`backend/extraction/title_generator.py`)

Uses KeyBERT with smart heuristics:

```python
from extraction.title_generator import get_title_generator

generator = get_title_generator()
title = generator.generate("MATH 0180 First Midterm Exam...", max_words=3)
# Returns: "MATH0180 Midterm Exam"
```

**Features:**
- Prioritizes course codes (MATH180, CS101)
- Extracts event types (Exam, Meeting, Deadline)
- Uses KeyBERT for semantic keyword extraction
- Filters out times, dates, and noise

### 2. Async Processing (`backend/processing/session_processor.py`)

Runs title generation in background thread:

```python
# Launch title generation (doesn't block main pipeline)
title_thread = threading.Thread(
    target=self._generate_and_update_title,
    args=(session_id, text, {}),
    daemon=True
)
title_thread.start()

# Main pipeline continues immediately
identification_result = self.agent_1_identification.execute(...)
```

### 3. SSE Streaming Endpoint (`backend/sessions/routes.py`)

Streams real-time updates to frontend:

```python
GET /api/sessions/<session_id>/stream

# Events:
- init: Initial session state
- title: New title generated {"title": "MATH180 Midterm"}
- status: Status update {"status": "processing"}
- complete: Processing done {"status": "processed"}
- timeout: Stream timeout
```

---

## Frontend Implementation

### 1. SSE Hook (`useSessionTitleStream`)

Connects to backend and receives real-time updates:

```typescript
import { useSessionTitleStream } from './sessions'

function MyComponent({ sessionId }) {
  const { title, isLoading, error, status } = useSessionTitleStream(sessionId)

  return (
    <div>
      {isLoading && <Skeleton />}
      {title && <TypingText text={title} speed={30} />}
    </div>
  )
}
```

**Features:**
- Automatic connection/cleanup
- Error handling
- Status tracking
- Callback support

### 2. Typing Animation (`TypingText`)

Typewriter effect for smooth reveal:

```typescript
import { TypingText } from './components'

<TypingText
  text="MATH180 Midterm"
  speed={30}
  onComplete={() => console.log('Done!')}
/>
```

### 3. Complete Component (`SessionTitleDisplay`)

All-in-one solution with skeleton ‚Üí typing ‚Üí final state:

```typescript
import { SessionTitleDisplay } from './sessions'

<SessionTitleDisplay
  sessionId={session.id}
  fallbackTitle="New Session"
  enableTypingAnimation={true}
  typingSpeed={30}
  onTitleComplete={(title) => console.log('Title:', title)}
/>
```

**States:**
1. **Loading:** Shows skeleton while waiting
2. **Streaming:** Receives title from SSE
3. **Animating:** Typing animation reveals title
4. **Complete:** Final static title displayed

---

## Usage in Menu Sidebar

### Before (blocking):
```typescript
// Old: Title generated by LLM Agent 0 (slow, blocking)
const session = createSession(...)
// Wait for Agent 0...
sidebar.addSession(session) // Only shows after 1-2s delay
```

### After (non-blocking):
```typescript
// New: Session created immediately with placeholder
const session = createSession(...)
sidebar.addSession(session) // Shows instantly with skeleton

// Title streams in asynchronously (50-300ms later)
<SessionTitleDisplay
  sessionId={session.id}
  fallbackTitle="New Session"
/>
```

---

## Database Migration

Run this in Supabase SQL Editor:

```sql
-- Add title column to sessions table
ALTER TABLE sessions
ADD COLUMN IF NOT EXISTS title VARCHAR(100);

-- Add index for faster searches
CREATE INDEX IF NOT EXISTS idx_sessions_title ON sessions(title);
```

---

## Example Titles Generated

| Input | Generated Title |
|-------|----------------|
| "MATH 0180 First Midterm Exam..." | MATH0180 Midterm Exam |
| "Team standup meeting tomorrow..." | Standup Meeting Discuss |
| "ENGN 0520 Homework 3 due Tuesday..." | ENGN0520 Homework Due |
| "CS 1410 Final project presentation..." | CS1410 Final Project |
| "Shabbat dinner at Hillel Friday..." | Dinner Hillel Shabbat |

---

## Performance

- **Title Generation:** 50-300ms (KeyBERT)
- **SSE Latency:** ~10-50ms (local network)
- **Typing Animation:** 30ms/char √ó 20 chars = 600ms
- **Total Time to Display:** 650-950ms

**vs Old Approach:**
- Agent 0 (LLM): 1-2 seconds (blocked entire pipeline)
- **Improvement:** 2-4x faster + non-blocking!

---

## Testing

### Backend Test:
```bash
cd backend
python test_title_generator.py
```

### Frontend Test:
```bash
cd frontend
npm run dev

# Then submit text and watch:
# 1. Session appears instantly with skeleton
# 2. Title streams in (check DevTools ‚Üí Network ‚Üí EventSource)
# 3. Typing animation reveals title
# 4. Final title displayed
```

### Manual SSE Test:
```bash
# Create a session, then:
curl http://localhost:5000/api/sessions/<session_id>/stream

# Watch events stream in real-time
```

---

## Troubleshooting

### Title not appearing?

1. **Check backend logs:** Look for "‚úì Title generated for session..."
2. **Check SSE connection:** DevTools ‚Üí Network ‚Üí Filter: EventSource
3. **Check database:** Verify title column exists and has data

### Typing animation not working?

1. **Check CSS:** Ensure TypingText.css is imported
2. **Check props:** Verify `enableTypingAnimation={true}`
3. **Check speed:** Try slower speed like `typingSpeed={50}`

### Skeleton stuck?

1. **Check SSE errors:** Look for connection failures
2. **Check timeout:** Stream times out after 10s
3. **Check fallback:** Verify `fallbackTitle` prop is set

---

## Future Enhancements

- [ ] Cache titles for similar inputs (embedding similarity)
- [ ] User feedback loop (learn from corrections)
- [ ] Multi-language support
- [ ] Custom title templates per user
- [ ] A/B test different title generation strategies

---

## Credits

**Built with:**
- [KeyBERT](https://github.com/MaartenGr/KeyBERT) - Keyword extraction
- [DistilBERT](https://huggingface.co/distilbert-base-uncased) - Lightweight BERT
- [Server-Sent Events](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events) - Real-time streaming
- Flask + React - Full-stack framework
